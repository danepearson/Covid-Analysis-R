---
title: "COVID Mortality Analysis Project"
author: "Dane Pearson, Dhriti Avala"
date: 12/2/2025
format: 
  html:
    code-fold: true
    code-summary: "Show the code"
    embed-resources: true
  pdf: default
# mainfont: "Times New Roman"
# sansfont: "Times New Roman"
# monofont: "Courier New"
execute:
  warning: false
  message: false
---


# Statistical Analysis of US COVID-19 Mortality in R:

---

## Install packages:
```{r}
library(lubridate)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(maps)
library(patchwork)
library(dplyr)

# For formatting tables nicely
library(knitr)
library(flextable)
library(modelsummary)
library(kableExtra)


```


## Load data:
```{r}
original_df <- read.csv(
  "data/COVID-19_Deaths_by_Sex_Age.csv",
  stringsAsFactors = TRUE
)

state_populations_data <- read.csv(
  "data/state_populations.csv",
  stringsAsFactors = TRUE
)

```


## EDA:

### Make summary tables of both datasets:
```{r}
original_summary <- summary(original_df)
state_pop_summary <- summary(state_populations_data)

kable(
  original_summary,
  caption = "Original dataset summary",
  digits = 1,
  align = "l"
)

kable(
  state_pop_summary,
  caption = "State populations dataset summary",
  digits = 1,
  align = "l"
)

```


First convert Covid-19 Death column from factor to numeric, and remove commas in numbers:

```{r}
original_df$COVID.19.Deaths <- as.numeric(gsub(
  ",",
  "",
  original_df$COVID.19.Deaths
))

# Ensure it was converted correctly
# class(original_df$COVID.19.Deaths)
```

### Check for missing values:

```{r}
# Count num of missing values in the columns we care about
# (Some columns we will use have missing values intentionally based on schema)

col_nas <- colSums(is.na(original_df[, c(
  "Group",
  "State",
  "Sex",
  "Age.Group",
  "COVID.19.Deaths"
)]))

# Convert to a data frame with one row
col_nas_df <- as.data.frame(t(col_nas))

kable(
  col_nas_df,
  caption = "NAs per column",
  digits = 1,
  align = "c"
)
```

I have chosen not to remove the missing values (NAs) in "COVID.19.Deaths" because the CDC intentionally "suppresses" (replaces with NA) populations that are too small for confidentiality purposes. I do not want to create bias in the data by removing data from smaller populations.


### Verify no “Month” values fall outside 1-12:
```{r}
value_range <- range(original_df$Month, na.rm = TRUE)
print(paste(
  "Range of 'Month' column values:",
  value_range[1],
  "to",
  value_range[2]
))
```

### Ensure no negative values for Covid-19 Deaths:

```{r}
min_value <- min(original_df$COVID.19.Deaths)
print(paste("Minimum value:", min_value))
```


### Plot total COVID-19 deaths over time in the U.S.

```{r}
deaths_per_month_df <- original_df %>%
  filter(
    Group == "By Month" &
      Sex == "All Sexes" &
      Age.Group == "All Ages" &
      State == "United States"
  ) |>
  dplyr::select(Year, Month, State, Sex, Age.Group, COVID.19.Deaths) %>%
  mutate(
    MonthDate = ymd(paste(Year, Month, "01", sep = "-"))
  )

# deaths_per_month_df

ggplot(data = deaths_per_month_df, aes(x = MonthDate, y = COVID.19.Deaths)) +
  geom_point() +
  geom_smooth() +
  labs(
    title = "COVID-19 Deaths Over Time in U.S. (2020-2023)",
    x = "Time",
    y = "Covid-19 Deaths"
  ) +
  theme_minimal()
```


##### Deaths from COVID-19 spiked drastically in late 2020 and early 2021, with the death rate lowering in mid 2021 and leveling off by early 2023. By mid-2021, the US began administering booster shots, over 70% of the US had received at least one dose of the vaccine, and 60% were fully vaccinated. This could help to explain how the national death rate began declining at about the same time, since the vaccine has been an effective way to prevent covid-related hospitalizations and transmission of the virus.


### Did certain months have higher average deaths across all years?

```{r}
# Boxplot for each month across all years in the dataset
ggplot(
  data = deaths_per_month_df,
  aes(x = factor(Month), y = COVID.19.Deaths)
) +
  geom_boxplot(color = "black", fill = "royalblue", alpha = 0.3) +
  geom_point(position = position_jitter(width = 0), alpha = 0.4) +
  labs(
    title = "Distribution of Average Monthly COVID Deaths in U.S. (2020-2023)",
    x = "Month",
    y = "COVID-19 Deaths"
  ) +
  theme_minimal()


# summary(deaths_per_month_df)
```

##### Based on the boxplot, we can see that the average deaths per month across all years (2020-2023) peaked in January and December. This indicates a clear pattern of there being higher death rates in colder months, suggesting that the cold weather increases likelihood and spread of the virus. This may be due to the cold and dry air helping the virus survive longer and compromising people's immune systems, in addition to people spending more time indoors in close contact, allowing it to spread more easily.


### How did deaths vary across age groups in the US?

```{r}
deaths_by_ages <- original_df %>%
  filter(
    Group == "By Total" &
      Sex == "All Sexes" &
      State == "United States" &
      Age.Group != "All Ages"
  ) |>
  dplyr::select(Age.Group, COVID.19.Deaths)

# I realized there are overlapping age groups so I have to remove the redundant ones
deaths_by_ages_clean <- deaths_by_ages %>%
  filter(
    !Age.Group %in%
      c(
        "0-17 years",
        "18-29 years",
        "30-39 years",
        "40-49 years",
        "50-64 years"
      )
  )

kable(
  deaths_by_ages_clean,
  caption = "Total COVID-19 Deaths per Age group",
  digits = 1,
  col.names = c("Age Group", "Total Deaths"),
  align = "l"
)

# Add threshold to group together smaller slices
threshold <- 0.02 * sum(deaths_by_ages_clean$COVID.19.Deaths)

# Group the smaller slices
deaths_by_ages_clean$group <- ifelse(
  deaths_by_ages_clean$COVID.19.Deaths < threshold,
  "Younger than 35",
  as.character(deaths_by_ages_clean$Age.Group)
)

agg <- aggregate(COVID.19.Deaths ~ group, deaths_by_ages_clean, sum)

# Plot as pie chart
pie(
  agg$COVID.19.Deaths,
  labels = agg$group,
  main = "Total Deaths by Age Group in the U.S. (2020-2023)"
)
```


### Choropleth heatmap:

##### First, we need to get the populations of each state by doing a left join of US census data on the State column of the original dataset. Below are the first few rows of each of the datasets used in the join:

```{r}
# Right dataset
state_pops_clean <- state_populations_data |>
  dplyr::select(
    NAME,
    POPESTIMATE2020,
    POPESTIMATE2021,
    POPESTIMATE2022,
    POPESTIMATE2023
  ) %>%
  rename(State = NAME)

head_state_pops <- head(state_pops_clean, 3)

kable(
  head_state_pops,
  caption = "State Populations Dataset (right data)",
  digits = 1,
  col.names = c(
    "State",
    "2020 Population",
    "2021 Population",
    "2022 Population",
    "2023 Population"
  ),
  align = "l"
)

# Left dataset where each row is a state and its population during a year
left_df <- original_df %>%
  filter(
    Group == "By Year",
    Sex != "All Sexes",
    # Age.Group == "All Ages"
  ) |>
  dplyr::select(State, Year, COVID.19.Deaths, Sex, Age.Group)

head_left <- head(left_df, 3)

kable(
  head_left,
  caption = "Original Mortality Dataset (left data)",
  digits = 1,
  col.names = c(
    "State",
    "Year",
    "COVID-19 Deaths",
    "Sex",
    "Age Group"
  ),
  align = "l"
)

# Make the right dataset long so it has one row for each state and year pair for compatible joining
state_pops_long <- state_pops_clean %>%
  pivot_longer(
    cols = starts_with("POPESTIMATE"),
    names_to = "Year",
    values_to = "Population"
  ) %>%
  mutate(
    Year = as.integer(gsub("POPESTIMATE", "", Year)) # Removes "POPESTIMATE"
  )

# Join the two datasets using a left join
joined_df <- left_df %>%
  left_join(state_pops_long, by = c("State", "Year")) %>%
  # filter(
  #   Age.Group == "All Ages"
  # ) %>%
  mutate(
    deaths_per_100000 = (COVID.19.Deaths / Population) * 100000,
    State = tolower(State) # state names must be lowercase for choropleth map
  )

head_joined <- head(joined_df, 3)

kable(
  head_joined,
  caption = "Left Join of Mortality and Populations Datasets",
  digits = 1,
  col.names = c(
    "State",
    "Year",
    "COVID-19 Deaths",
    "Sex",
    "Age Group",
    "Population",
    "Deaths per 100,000"
  ),
  align = "l"
)
```

##### Add a "region" and death rate columns to the new joined data.
```{r}
# Define the states in each region:
west <- c(
  "alaska",
  "hawaii",
  "washington",
  "oregon",
  "california",
  "nevada",
  "idaho",
  "montana",
  "wyoming",
  "utah",
  "colorado",
  "arizona",
  "new mexico"
)

midwest <- c(
  "north dakota",
  "south dakota",
  "nebraska",
  "kansas",
  "minnesota",
  "iowa",
  "missouri",
  "wisconsin",
  "illinois",
  "indiana",
  "michigan",
  "ohio"
)

south <- c(
  "delaware",
  "maryland",
  "virginia",
  "west virginia",
  "kentucky",
  "tennessee",
  "north carolina",
  "south carolina",
  "georgia",
  "florida",
  "alabama",
  "mississippi",
  "arkansas",
  "louisiana",
  "texas",
  "oklahoma",
  "district of columbia"
)

northeast <- c(
  "maine",
  "new hampshire",
  "vermont",
  "massachusetts",
  "rhode island",
  "connecticut",
  "new york",
  "new jersey",
  "pennsylvania"
)

# Add region column, remove rows with NA in region (for territories), and sort by year ascending
joined_regional_df <- joined_df %>%
  mutate(
    region = case_when(
      State %in% west ~ "west",
      State %in% midwest ~ "midwest",
      State %in% south ~ "south",
      State %in% northeast ~ "northeast",
      TRUE ~ NA_character_
    )
  ) %>%
  mutate(region = as.factor(region)) %>%
  drop_na() %>%
  arrange(Year)

# head(joined_regional_df, 3)
```

##### Prepare subsets of the joined data by each year.

```{r}
joined_2020 <- joined_regional_df %>%
  filter(Year == "2020")

joined_2021 <- joined_regional_df %>%
  filter(Year == "2021")

joined_2022 <- joined_regional_df %>%
  filter(Year == "2022")

joined_2023 <- joined_regional_df %>%
  filter(Year == "2023")
```

##### Finally, plot the choropleth maps for 2020-2023:

```{r}

# Load US map geometry
us_map <- map_data("state")

# Merge the polygon map with death rate dataframe
plot_map_df <- us_map %>%
  left_join(joined_df, by = c("region" = "State"))

# Plot the heatmaps on a 2x2 grid by year
ggplot(plot_map_df, aes(long, lat, group = group, fill = deaths_per_100000)) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_fixed(1.3) +
  scale_fill_viridis_c(option = "viridis") +
  facet_wrap(~Year, ncol = 2) +
  labs(
    title = "COVID-19 Mortality Rates by State (per 100,000, colorblind friendly)",
    fill = "Deaths per 100,000"
  ) +
  theme_minimal() +
  theme_void() + # Remove background and axes
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )

```

---

## Statistical Analysis:

#### *Can we predict death rates using the year, region and sex variables?*

### Multiple Linear Regression:

<!-- ##### The dataset used for the Multiple Linear Regression has one row for each unique combination of Year × Month × State × Sex × Age Group. -->


```{r}

# monthly_age_sex_deaths <- original_df %>%
#   filter(Group == "By Month") %>%
#   distinct(Year, Month, State, Sex, Age.Group, .keep_all = TRUE) %>%
#   select(Group, Year, Month, State, Sex, Age.Group, COVID.19.Deaths)

# # str(monthly_age_sex_deaths)

# summary(joined_regional_df)

joined_regional_no_AllAges_df <- joined_regional_df %>%
  filter(Age.Group != "All Ages")
# summary(joined_regional_no_AllAges_df)

mlr_model <- lm(
  deaths_per_100000 ~ factor(Year) + Age.Group + region + Sex,
  data = joined_regional_no_AllAges_df
)

summary(mlr_model)
```

##### **Comments:**
###### - The intercept is: Year = 0 (redundant), region = midwest, and Sex = Female
###### - We converted the Year variable into a factor for the MLR here because COVID death rates do not decline linearly over time. Treating the years as categorical allows us to fit separate means for each year, captures non-linear year effects, and reduces the residual patterns

##### **Interpretation:**
- The model explains about 63.6% of the variation in COVID-19 deaths per 100,000
  - Adjusted R² = 0.636
- COVID mortality peaked in 2021, then sharply declined in 2022–2023
  - Mortality rates were 1.63 per 100k higher than 2020
- All age groups below 40 years old had no statistically significant difference from the baseline age group of 0-17 years
- The statistical sifgnificance of age group increases as age groups increase, with the 85+ age group exhibiting the highest mortality risk relative to the baseline
- The south had significantly higher COVID mortality per 100k than all other regions
  - States in the South are expected to have COVID-19 death rates that are about 0.66 deaths per 100,000 population higher than the Midwest, after accounting for differences in year, age group, and sex



#### **Diagnostic plots for regression:**


```{r}
library(ggplot2)
library(broom)

# Residuals vs Fitted
# Check linearity and homoscedasticity
ggplot(mlr_model, aes(.fitted, .resid)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residuals vs Fitted", x = "Fitted", y = "Residuals") +
  theme_minimal()
```

##### The Residuals vs Fitted plot demonstrates that the model clearly violates the asumption of **linearity**. By looking at the plot, we can see that the predictors (year, region, and sex) and the response variable (death rate) are not linearly related. The wavy LOESS curve demonstrates an uneven spread around the residuals = 0 line, indicating that the model is potentially overpredicting in some ranges and underpredicting in others. The assumption of **constant variance** (homoscedasticity) is also violated, exhibited by the widening funnel shape in the plot. The residuals at lower fitted values are closer together, while those at higher fitted values spread out more dramatically. This means that the variance in error grows as the predicted mortality increases.

```{r}
# Q-Q Plot
# Check normality of residuals
ggplot(mlr_model, aes(sample = .resid)) +
  stat_qq(alpha = 0.4) +
  stat_qq_line(color = "blue") +
  labs(
    title = "Q-Q Plot",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_minimal()
```

##### The Q-Q plot demonstrates that the model violates the asumption of **normality of the residuals**. The points slightly deviate below the line at and below theoretical quantiles of -3, while deviating much further above the line as the quantiles increase in value. The data is light-tailed, suggesting the data may be right-skewed and the model potentially underestimating high death-rate observations.


### Poisson Regression:
##### Use Poission regression to more accurately model the COVID deaths, since our data is count data not continuous.

```{r}
poisson_regression <- glm(
  COVID.19.Deaths ~ Sex + region + Year + Age.Group,
  family = poisson,
  offset = log(Population), # so expected deaths scale proportionally with population
  data = joined_regional_no_AllAges_df
)

summary(poisson_regression)
```

#### **Interpretation:**
- The COVID-19 mortality rate for males is around 28% higher than for females
  - IRR = exp(0.2448) ≈ 1.28
- The Northeast had a 14% lower COVID-19 mortality rate than in the Midwest
  - IRR = exp(−0.1501) ≈ 0.86
- The South had a 10% higher COVID-19 mortality rate than the Midwest
  - IRR = exp(0.0938) ≈ 1.10
- The West had a 16% lower mortality rate than the Midwest
  - IRR = exp(−0.1707) ≈ 0.84
- Each additional year predicts a 35% decrease in the COVID-19 mortality rate
  - IRR = exp(−0.4322) ≈ 0.65
- Older adults showed much higher COVID-19 mortality rates, with the 85+ group having a more than 150 times higher death rate than 0-17 year olds
- Overall, COVID-19 mortality rates grow with age, which is the strongest predictor of death in our Poisson regression model


### Negative Binomial Regression:

```{r}
library(MASS)

# define model, using population as offset to scale porportionally
neg_binomial_regression <- glm.nb(
  COVID.19.Deaths ~ Sex + region + Year + Age.Group + offset(log(Population)),
  data = joined_regional_no_AllAges_df
)

summary(neg_binomial_regression)
```

#### **Interpretation:**
- Male COVID-19 mortality rates are about 37% higher than female mortality rates
  - IRR = exp(0.31441) ≈ 1.37
- The northeast had ~24% lower mortality rates than the midwest 
  - IRR = exp(−0.27157) ≈ 0.76
- The south had ~36% higher mortality rates than the midwest
  - exp(0.30610) ≈ 1.36
- The west had ~4% higher mortality rates than the midwest
  - exp(-1.707e-01) ≈ 0.84
- Each additional year predicts a 44% decrease in mortality rates
  - exp(−0.58368) ≈ 0.56
- The 85+ year old group had a more than 190 times higher death rate than 0-17 year olds
- Similarly to the Poisson regression model, the Negative Binomial regression model predicts that COVID-19 mortality rates increase with age


### Compare Poisson vs Negative Binomial Regression:
```{r}
aic <- AIC(poisson_regression, neg_binomial_regression)
kable(aic, caption = "AIC Results", digits = 1, align = "lcr")
```

##### The AIC (Akaike Information Criterion) comparison table comfirms that the Negative Binomial regression model performs better than poisson regression in predicting COVID mortality rates. The negative binomial regression model has a much lower AIC value of 44,747.3 compared to that of the Poisson Regression model (480,266.0). This demonstrates that the Negative Binomial approach exhibits a lower estimated prediction error and therefore better fits the mortality data. 


```{r}
# exp(cbind(
#   IRR = coef(neg_binomial_regression),
#   confint(neg_binomial_regression)
# ))

joined_regional_no_AllAges_df$pred_nb <- predict(
  neg_binomial_regression,
  type = "response"
)

ggplot(joined_regional_no_AllAges_df, aes(x = pred_nb, y = COVID.19.Deaths)) +
  geom_point(alpha = 0.4) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "blue") +
  labs(
    title = "Observed vs Predicted COVID Deaths (Negative Binomial)",
    x = "Predicted Deaths",
    y = "Observed Deaths"
  ) +
  theme_minimal()

```

##### The Observed vs Predicted COVID Deaths plot shows that the Negative Binomial Regression model is both underpredicting and overpredicting covid deaths. Notably, the fan-shaped pattern indicates that the model's prediction accuracy lessens as the number of deaths increase. Despite this, the model does a decent job of predicting the number of COVID deaths when the observed deaths are below about 60,000.

---

### Two-way ANOVA:
##### How do age, sex, and region influence mortality by each month?

```{r}
anova_model <- aov(
  COVID.19.Deaths ~ Age.Group * Sex * region,
  data = joined_regional_no_AllAges_df
)
summary(anova_model)
anova_summary <- summary(anova_model)

# apa.aov.table(lm_output = anova_model, filename = "anova_table.rtf") # Exports to RTF, can be converted to PDF

# anova_df <- as.data.frame(summary(anova_model)[[1]])

# kable(
#   anova_df,
#   format = "latex",
#   booktabs = TRUE,
#   caption = "ANOVA Results for COVID-19 Mortality Model",
#   digits = 3
# ) %>%
#   kable_styling(
#     latex_options = c("hold_position", "striped")
#   )

```

#### Interpretation:
- Age group, sex, and region eachhave statistically significant effects on COVID-19 mortality rates in the US, as they have p-values less than the alpha level of 0.05. This means that, mortality rates differ across age groups, between sexes, across regions when averaged over the other factors.

- The interaction between age group and sex is statistically significant as well since it also has a p-value less than the alpha level of 0.05. This means that the effect of age group on mortality rates depends on sex (and changes as sex changes), and vice versa. In the data this indicates that the difference in mortality rates between age groups is not consistent across sexes. Similarly, the difference in mortality rates between sexes is not consistent across age groups.

- The interactions between Age Group x Region, Sex x Region, & Age Group x Sex x Region are not statistically significant. This means there is no evidence that the combined effect of those pairs (or all three together) influences mortality outside of what is already explained by the individual main effects and the interaction between Age Group × Sex.


### Interaction plot:
```{r}
# Calculate means for each group
interaction_subset <- joined_regional_no_AllAges_df %>%
  filter(Age.Group != "Under 1 year") %>%
  group_by(Age.Group, Sex) %>%
  summarise(mean_deaths = mean(COVID.19.Deaths))

# Create the interaction plot
ggplot(
  interaction_subset,
  aes(x = Age.Group, y = mean_deaths, group = Sex, color = Sex)
) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  labs(
    title = "Interaction of Age Group & Sex",
    x = "Age Group",
    y = "Mean COVID-19 Deaths"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# summary(joined_regional_no_AllAges_df)
```

#### Interpretation:
- From ages 0-44 years old, the interaction plot suggests that sex has little effect on predicted COVID-19 deaths
- According to the plot, being male increases COVID-19 deaths much more in those aged 45-84 years old than being female, as the average COVID-19 deaths for males is much higher in that age bracket
- After age 84, the effect of sex on predicted COVID-19 deaths reverses depending on age group, indicating an interaction between the two predictive variables

---

### Panel data plot:

```{r}
# summary(joined_regional_no_AllAges_df)

region_year_panel <- joined_regional_no_AllAges_df %>%
  group_by(region, Year) %>%
  summarise(
    deaths = sum(COVID.19.Deaths, na.rm = TRUE),
    population = sum(Population, na.rm = TRUE),
    deaths_per_100000 = (deaths / population) * 100000,
    .groups = "drop"
  )

ggplot(
  region_year_panel,
  aes(x = Year, y = deaths_per_100000, color = region, group = region)
) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) + # optional—remove this line if you don't want points
  labs(
    title = "COVID-19 Death Rates by Region (per 100,000)",
    x = "Year",
    y = "Deaths per 100,000",
    color = "Region"
  ) +
  scale_x_continuous(
    breaks = c(2020, 2021, 2022, 2023),
    labels = c("2020", "2021", "2022", "2023")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(size = 11)
  )

```

#### Interpretation:
- All regions show a clear decline in COVID-19 mortality from 2021 to 2023
- Mortality peaked in 2021 for every region
- The South has the highest mortality peak, while the Northeast shows the lowest overall rates
- By 2023, mortality drops to very low levels across all regions, indicating effective vaccinations, improved treatment, and reduced severity in later variants