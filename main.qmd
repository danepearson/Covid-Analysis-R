---
title: "COVID Mortality Analysis Project"
author: "Dane Pearson, Dhriti Avala"
date: 12/2/2025
format: 
  elsevier-html:
    code-fold: true
    code-summary: "Show the code"
    embed-resources: true
  pdf: default
  elsevier-pdf:
    keep-tex: true
    engine: xelatex # or lualatex
    journal:
      name: Journal Name
      formatting: preprint
      # model: 3p # Don't set a model with preprint
      cite-style: authoryear
# mainfont: "Times New Roman"
# sansfont: "Times New Roman"
# monofont: "Courier New"
execute:
  warning: false
  message: false
---


# Statistical Analysis of United States COVID-19 Data

## Install packages:
```{r}
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(maps)

```


## Load data:
```{r}
original_df <- read.csv(
  "COVID-19_Deaths_by_Sex_Age.csv",
  stringsAsFactors = TRUE
)

state_populations_data <- read.csv(
  "state_populations.csv",
  stringsAsFactors = TRUE
)

```


## EDA:

First convert Covid-19 Death column from factor to numeric, and remove commas in numbers:

```{r}
original_df$COVID.19.Deaths <- as.numeric(gsub(
  ",",
  "",
  original_df$COVID.19.Deaths
))

# Ensure it was converted correctly
# class(original_df$COVID.19.Deaths)
```

### Check for missing values:

```{r}
# names(original_df)

# Count num of missing values in the columns we care about
# (Some columns we will use have missing values intentionally based on schema)
colSums(is.na(original_df[, c(
  "Group",
  "State",
  "Sex",
  "Age.Group",
  "COVID.19.Deaths"
)]))
```

I have chosen not to remove the missing values (NAs) in "COVID.19.Deaths" because the CDC intentionally "suppresses" (replaces with NA) populations that are too small for confidentiality purposes. I do not want to create bias in the data by removing data from smaller populations.


### Verify no “Month” values fall outside 1-12:
```{r}
value_range <- range(original_df$Month, na.rm = TRUE)
print(paste(
  "Range of 'Month' column values:",
  value_range[1],
  "to",
  value_range[2]
))
```

### Ensure no negative values for Covid-19 Deaths:

```{r}
min_value <- min(original_df$COVID.19.Deaths)
print(paste("Minimum value:", min_value))
```


### Plot total COVID-19 deaths over time in the U.S.

```{r}
deaths_per_month_df <- original_df %>%
  filter(
    Group == "By Month" &
      Sex == "All Sexes" &
      Age.Group == "All Ages" &
      State == "United States"
  ) %>%
  select(Year, Month, State, Sex, Age.Group, COVID.19.Deaths) %>%
  mutate(
    MonthDate = ymd(paste(Year, Month, "01", sep = "-"))
  )

# deaths_per_month_df

ggplot(data = deaths_per_month_df, aes(x = MonthDate, y = COVID.19.Deaths)) +
  geom_point() +
  geom_smooth() +
  labs(
    title = "COVID-19 Deaths Over Time in U.S. (2020-2023)",
    x = "Time",
    y = "Covid-19 Deaths"
  ) +
  theme_minimal()
```


Deaths from COVID-19 spiked drastically in late 2020 and early 2021, with the death rate lowering in mid 2021 and leveling off by early 2023. By mid-2021, the US began administering booster shots, over 70% of the US had received at least one dose of the vaccine, and 60% were fully vaccinated. This could help to explain how the national death rate began declining at about the same time, since the vaccine has been an effective way to prevent covid-related hospitalizations and transmission of the virus.


### Did certain months have higher average deaths across all years?

```{r}
# Boxplot for each month across all years in the dataset
ggplot(
  data = deaths_per_month_df,
  aes(x = factor(Month), y = COVID.19.Deaths)
) +
  geom_boxplot(color = "black", fill = "royalblue", alpha = 0.3) +
  labs(
    title = "Distribution of Average Monthly COVID Deaths in U.S. (2020-2023)",
    x = "Month",
    y = "COVID-19 Deaths"
  ) +
  theme_minimal()
```

Based on the boxplot, we can see that the average deaths per month across all years (2020-2023) peaked in January and December. This indicates a clear pattern of there being higher death rates in colder months, suggesting that the cold weather increases likelihood and spread of the virus. This may be due to the cold and dry air helping the virus survive longer and compromising people's immune systems, in addition to people spending more time indoors in close contact, allowing it to spread more easily.


### How did deaths vary across age groups in the US?

```{r}
deaths_by_ages <- original_df %>%
  filter(
    Group == "By Total" &
      Sex == "All Sexes" &
      State == "United States" &
      Age.Group != "All Ages"
  ) %>%
  select(Age.Group, COVID.19.Deaths)

# I realized there are overlapping age groups so I have to remove the redundant ones
deaths_by_ages_clean <- deaths_by_ages %>%
  filter(
    !Age.Group %in%
      c(
        "0-17 years",
        "18-29 years",
        "30-39 years",
        "40-49 years",
        "50-64 years"
      )
  )

deaths_by_ages_clean

# Add threshold to group together smaller slices
threshold <- 0.02 * sum(deaths_by_ages_clean$COVID.19.Deaths)

# Group the smaller slices
deaths_by_ages_clean$group <- ifelse(
  deaths_by_ages_clean$COVID.19.Deaths < threshold,
  "Younger than 35",
  as.character(deaths_by_ages_clean$Age.Group)
)

agg <- aggregate(COVID.19.Deaths ~ group, deaths_by_ages_clean, sum)

# Plot as pie chart
pie(
  agg$COVID.19.Deaths,
  labels = agg$group,
  main = "Total Deaths by Age Group in the U.S. (2020-2023)"
)
```


### Choropleth heatmap:

##### First, we need to get the populations of each state by doing a left join of US census data on the State column of the original dataset.

##### Below you can see the first few rows of each dataset, with the last one being the left join of the two of them with an added death rate column:

```{r}
# Right dataset
state_pops_clean <- state_populations_data %>%
  select(
    NAME,
    POPESTIMATE2020,
    POPESTIMATE2021,
    POPESTIMATE2022,
    POPESTIMATE2023
  ) %>%
  rename(State = NAME)

head(state_pops_clean, 3)

# Left dataset where each row is a state and its population during a year
left_df <- original_df %>%
  filter(
    Group == "By Year",
    Sex != "All Sexes",
    Age.Group == "All Ages"
  ) %>%
  select(State, Year, COVID.19.Deaths, Sex)

head(left_df, 3)

# Make the right dataset long so it has one row for each state and year pair for compatible joining
state_pops_long <- state_pops_clean %>%
  pivot_longer(
    cols = starts_with("POPESTIMATE"),
    names_to = "Year",
    values_to = "Population"
  ) %>%
  mutate(
    Year = as.integer(gsub("POPESTIMATE", "", Year)) # Removes "POPESTIMATE"
  )

# Join the two datasets using a left join
joined_df <- left_df %>%
  left_join(state_pops_long, by = c("State", "Year")) %>%
  mutate(
    deaths_per_100000 = (COVID.19.Deaths / Population) * 100000,
    State = tolower(State) # state names must be lowercase for choropleth map
  )

head(joined_df, 3)
```

# Add a "region" column to the new joined data for by-region analysis:
```{r}
# Define the states in each region:
west <- c(
  "alaska",
  "hawaii",
  "washington",
  "oregon",
  "california",
  "nevada",
  "idaho",
  "montana",
  "wyoming",
  "utah",
  "colorado",
  "arizona",
  "new mexico"
)

midwest <- c(
  "north dakota",
  "south dakota",
  "nebraska",
  "kansas",
  "minnesota",
  "iowa",
  "missouri",
  "wisconsin",
  "illinois",
  "indiana",
  "michigan",
  "ohio"
)

south <- c(
  "delaware",
  "maryland",
  "virginia",
  "west virginia",
  "kentucky",
  "tennessee",
  "north carolina",
  "south carolina",
  "georgia",
  "florida",
  "alabama",
  "mississippi",
  "arkansas",
  "louisiana",
  "texas",
  "oklahoma",
  "district of columbia"
)

northeast <- c(
  "maine",
  "new hampshire",
  "vermont",
  "massachusetts",
  "rhode island",
  "connecticut",
  "new york",
  "new jersey",
  "pennsylvania"
)

# Add region column, remove rows with NA in region (for territories), and sort by year ascending
joined_regional_df <- joined_df %>%
  mutate(
    region = case_when(
      State %in% west ~ "west",
      State %in% midwest ~ "midwest",
      State %in% south ~ "south",
      State %in% northeast ~ "northeast",
      TRUE ~ NA_character_
    )
  ) %>%
  mutate(region = as.factor(region)) %>%
  drop_na() %>%
  arrange(Year)

head(joined_regional_df, 3)
```

##### Now prepare subsets of the joined data by each year:

```{r}
joined_2020 <- joined_regional_df %>%
  filter(Year == "2020")

joined_2021 <- joined_regional_df %>%
  filter(Year == "2021")

joined_2022 <- joined_regional_df %>%
  filter(Year == "2022")

joined_2023 <- joined_regional_df %>%
  filter(Year == "2023")
```

##### Finally, plot the choropleth maps across 2020-2023:

```{r}

# Load US map geometry
us_map <- map_data("state")

# Merge the polygon map with death rate dataframe
plot_map_df <- us_map %>%
  left_join(joined_df, by = c("region" = "State"))

# Plot the heatmaps on a 2x2 grid by year
ggplot(plot_map_df, aes(long, lat, group = group, fill = deaths_per_100000)) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_fixed(1.3) +
  scale_fill_viridis_c(option = "viridis") +
  facet_wrap(~Year, ncol = 2) +
  labs(
    title = "COVID-19 Mortality Rates by State (per 100,000, colorblind friendly)",
    fill = "Deaths per 100,000"
  ) +
  theme_minimal() +
  theme_void() + # Remove background and axes
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )

```

---

## Statistical Analysis:

### Multiple Linear Regression:

<!-- ##### The dataset used for the Multiple Linear Regression has one row for each unique combination of Year × Month × State × Sex × Age Group. -->


```{r}

# monthly_age_sex_deaths <- original_df %>%
#   filter(Group == "By Month") %>%
#   distinct(Year, Month, State, Sex, Age.Group, .keep_all = TRUE) %>%
#   select(Group, Year, Month, State, Sex, Age.Group, COVID.19.Deaths)

# # str(monthly_age_sex_deaths)

mlr_model <- lm(
  deaths_per_100000 ~ Year + region + Sex,
  data = joined_regional_df
)

summary(mlr_model)

```

*The intercept is: Year = 0 (redundant), region = midwest, and Sex = Female*

#### **Diagnostic plots for regression:**


---

### Two-way ANOVA:
##### How do age, sex, and state influence mortality by each month?

```{r}
# anova_model <- aov(
#   COVID.19.Deaths ~ Age.Group * Sex,
#   data = monthly_age_sex_deaths
# )
# summary(anova_model)

```

### Panel data plot: